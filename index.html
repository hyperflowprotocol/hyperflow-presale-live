<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>HyperFlow Protocol - Token Presale</title>
    
    <!-- Mobile App Deep Link Support -->
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="theme-color" content="#2dd4bf">
    
    <!-- App Manifest -->
    <link rel="manifest" href="data:application/json;base64,ewogICJuYW1lIjogIkh5cGVyRmxvdyBQcm90b2NvbCIsCiAgInNob3J0X25hbWUiOiAiSHlwZXJGbG93IiwKICAic3RhcnRfdXJsIjogIi8iLAogICJkaXNwbGF5IjogInN0YW5kYWxvbmUiLAogICJ0aGVtZV9jb2xvciI6ICIjMmRkNGJmIiwKICAiYmFja2dyb3VuZF9jb2xvciI6ICIjMGYxNzJhIiwKICAiaWNvbnMiOiBbCiAgICB7CiAgICAgICJzcmMiOiAiZGF0YTppbWFnZS9zdmcreG1sO2Jhc2U2NCxQSE4yWnlCM2FXUjBhRDBpTVRBd0lpQm9aV2xuYUhROUlqRXdNQ0lpSUhacFpYZENiM2c5SWpBZ01DQXhNREFnTVRBd0lqNEtJQ0E4WkdWbWN6NEtJQ0FnSUNBOGJHbHVaV0ZzUjNKaFpHbGxiblFnYVdROUlteHZaMjlIY21Ga0lpQjROVDBpTUNVaUlIa3hQU0l3SlNJZ2VESTlJakV3TUNVaUlIa3lQU0l4TURBbElqNEtJQ0FnSUNBZ0lDQThjM1J2Y0NCdlptWnpaWFE5SWpBbElpQnpkSGxzWlQwaWMzUnZjQzFqYjJ4dmNqb2pNbVJrTkdKbUlqNDhMM04wYjNBK0NpQWdJQ0FnSUNBZ1BITjBiM0FnYjJabWMyVjBQU0l4TURBbElpQnpkSGxzWlQwaWMzUnZjQzFqYjJ4dmNqb2pNVFJpT0dFMklqNDhMM04wYjNBK0NpQWdJQ0E4TDJ4cGJtVmhja2R5WVdScFpXNTBQZ29nSUR3dlpHVm1jejRLSUNBOFkybHlZMnhsSUdONFBTSTFNQ0lnWTNrOUlqVXdJaUJ5UFNJME5TSXVZV2xzUFNKMWNtd29JMnh2WjI5SGNtRmtLU0k4TDJOcGNtTnNaVDRLSUNBOGRHVjRkQ0I0UFNJMk1DSXVLM2s5SWpVNElpQjBaWGgwTFdGdVkyaHZjakk5SXcxdGFXUmtaR3hsSnlCbWFXeHNQU0ozYUdsMFpTSWdabTl1ZEMxbVlXMXBiSGs5SWtsQmRHVnlJaUJtYjI1MExYZGxhV2RvZEQ0aU56QXdJaUJtYjI1MExYTnBlbVU5SWpNeUlqNUlSaUE4TDNSbGVIUStDand2YzNabklnPT0iLAogICAgICAic2l6ZXMiOiAiMTkyeDE5MiIsCiAgICAgICJ0eXBlIjogImltYWdlL3N2Zyt4bWwiCiAgICB9CiAgXQp9">
    
    <style>
        body {
            margin: 0;
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
            background: linear-gradient(135deg, #0f172a 0%, #1e293b 100%);
            color: #e2e8f0;
            min-height: 100vh;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
        }
        
        /* Mobile Optimizations */
        * {
            -webkit-tap-highlight-color: transparent;
            -webkit-touch-callout: none;
            -webkit-user-select: none;
            -moz-user-select: none;
            -ms-user-select: none;
            user-select: none;
        }
        
        input, textarea {
            -webkit-user-select: text;
            -moz-user-select: text;
            -ms-user-select: text;
            user-select: text;
        }
        
        .header {
            background: #1e293b;
            padding: 16px 20px;
            border-bottom: 1px solid #334155;
            display: flex;
            justify-content: space-between;
            align-items: center;
            position: sticky;
            top: 0;
            z-index: 100;
        }
        
        .logo {
            display: flex;
            align-items: center;
            gap: 12px;
        }
        
        .logo h1 {
            margin: 0;
            color: #2dd4bf;
            font-size: 24px;
            font-weight: 700;
        }
        
        .logo p {
            margin: 0;
            color: #94a3b8;
            font-size: 14px;
        }
        
        .connect-btn {
            background: linear-gradient(135deg, #2dd4bf, #14b8a6);
            border: none;
            padding: 12px 20px;
            border-radius: 8px;
            color: white;
            font-weight: 600;
            cursor: pointer;
            font-size: 14px;
            transition: all 0.2s;
            min-width: 120px;
            white-space: nowrap;
        }
        
        .connect-btn:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(45, 212, 191, 0.3);
        }
        
        .connect-btn:active {
            transform: translateY(0);
        }
        
        .connect-btn:disabled {
            opacity: 0.7;
            cursor: not-allowed;
        }
        
        .main-content {
            padding: 60px 20px;
            text-align: center;
            max-width: 800px;
            margin: 0 auto;
        }
        
        .title {
            font-size: clamp(32px, 8vw, 48px);
            font-weight: 800;
            color: #2dd4bf;
            margin-bottom: 20px;
            line-height: 1.2;
        }
        
        .subtitle {
            font-size: clamp(24px, 6vw, 32px);
            font-weight: 600;
            color: #e2e8f0;
            margin-bottom: 25px;
            line-height: 1.3;
        }
        
        .description {
            font-size: clamp(16px, 4vw, 20px);
            color: #94a3b8;
            margin-bottom: 40px;
            line-height: 1.5;
        }
        
        .wallet-status {
            margin-top: 30px;
            padding: 20px;
            background: rgba(34, 197, 94, 0.1);
            border: 1px solid #22c55e;
            border-radius: 12px;
            display: none;
        }
        
        .status-text {
            color: #22c55e;
            font-weight: 600;
            margin-bottom: 10px;
        }
        
        .wallet-address {
            font-family: 'SF Mono', monospace;
            font-size: 12px;
            color: #94a3b8;
            word-break: break-all;
            padding: 8px;
            background: rgba(0, 0, 0, 0.3);
            border-radius: 6px;
        }
        
        .presale-section {
            margin-top: 50px;
            padding: 30px 20px;
            background: rgba(15, 23, 42, 0.8);
            border: 1px solid #334155;
            border-radius: 16px;
            backdrop-filter: blur(10px);
        }
        
        .presale-title {
            font-size: clamp(24px, 6vw, 32px);
            font-weight: 700;
            color: #2dd4bf;
            margin-bottom: 20px;
        }
        
        .presale-stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin: 30px 0;
        }
        
        .stat-card {
            background: rgba(30, 41, 59, 0.6);
            padding: 20px 15px;
            border-radius: 12px;
            border: 1px solid #475569;
            transition: transform 0.2s;
        }
        
        .stat-card:hover {
            transform: translateY(-2px);
            border-color: #2dd4bf;
        }
        
        .stat-label {
            color: #94a3b8;
            font-size: 14px;
            margin-bottom: 8px;
        }
        
        .stat-value {
            color: #2dd4bf;
            font-size: clamp(18px, 5vw, 24px);
            font-weight: 700;
        }
        
        .buy-section {
            margin-top: 30px;
            padding: 25px 20px;
            background: rgba(20, 184, 166, 0.1);
            border: 1px solid #2dd4bf;
            border-radius: 12px;
        }
        
        .input-group {
            display: flex;
            flex-direction: column;
            gap: 15px;
            align-items: center;
            margin: 20px 0;
        }
        
        .buy-input {
            background: #1e293b;
            border: 1px solid #475569;
            border-radius: 8px;
            padding: 15px 16px;
            color: #e2e8f0;
            font-size: 16px;
            width: 100%;
            max-width: 200px;
            text-align: center;
            transition: border-color 0.2s;
        }
        
        .buy-input:focus {
            outline: none;
            border-color: #2dd4bf;
            box-shadow: 0 0 0 3px rgba(45, 212, 191, 0.1);
        }
        
        .conversion-arrow {
            color: #94a3b8;
            font-size: 18px;
            font-weight: 600;
        }
        
        .buy-btn {
            background: linear-gradient(135deg, #2dd4bf, #14b8a6);
            border: none;
            padding: 15px 30px;
            border-radius: 8px;
            color: white;
            font-weight: 600;
            cursor: pointer;
            font-size: 16px;
            margin-top: 15px;
            transition: all 0.2s;
            min-width: 120px;
        }
        
        .buy-btn:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(45, 212, 191, 0.3);
        }
        
        .buy-btn:active {
            transform: translateY(0);
        }
        
        .buy-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none;
        }
        
        /* Wallet Modal */
        .wallet-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            z-index: 1000;
            justify-content: center;
            align-items: center;
            padding: 20px;
            box-sizing: border-box;
        }
        
        .modal-content {
            background: #1e293b;
            padding: 30px 25px;
            border-radius: 16px;
            border: 1px solid #334155;
            max-width: 400px;
            width: 100%;
            position: relative;
            animation: modalSlideIn 0.3s ease-out;
        }
        
        @keyframes modalSlideIn {
            from {
                opacity: 0;
                transform: translateY(-20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        
        .modal-title {
            color: #2dd4bf;
            font-size: 24px;
            font-weight: 700;
            margin-bottom: 25px;
            text-align: center;
        }
        
        .wallet-option {
            display: flex;
            align-items: center;
            gap: 15px;
            padding: 18px 15px;
            background: rgba(15, 23, 42, 0.8);
            border: 1px solid #475569;
            border-radius: 12px;
            margin-bottom: 12px;
            cursor: pointer;
            transition: all 0.2s;
            position: relative;
            overflow: hidden;
        }
        
        .wallet-option:hover {
            border-color: #2dd4bf;
            background: rgba(45, 212, 191, 0.1);
            transform: translateY(-1px);
        }
        
        .wallet-option:active {
            transform: translateY(0);
        }
        
        .wallet-icon {
            width: 40px;
            height: 40px;
            background: linear-gradient(135deg, #2dd4bf, #14b8a6);
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: 700;
            font-size: 16px;
            flex-shrink: 0;
        }
        
        .wallet-info {
            flex: 1;
        }
        
        .wallet-info h3 {
            margin: 0 0 4px 0;
            color: #e2e8f0;
            font-size: 16px;
            font-weight: 600;
        }
        
        .wallet-info p {
            margin: 0;
            color: #94a3b8;
            font-size: 13px;
        }
        
        .close-modal {
            position: absolute;
            top: 15px;
            right: 20px;
            background: none;
            border: none;
            color: #94a3b8;
            font-size: 28px;
            cursor: pointer;
            padding: 5px;
            line-height: 1;
            transition: color 0.2s;
        }
        
        .close-modal:hover {
            color: #e2e8f0;
        }
        
        /* Mobile Responsive */
        @media (max-width: 768px) {
            .header {
                padding: 12px 16px;
            }
            
            .logo h1 {
                font-size: 20px;
            }
            
            .logo p {
                font-size: 12px;
            }
            
            .connect-btn {
                padding: 10px 16px;
                font-size: 13px;
                min-width: 100px;
            }
            
            .main-content {
                padding: 40px 16px;
            }
            
            .presale-section {
                padding: 25px 16px;
            }
            
            .presale-stats {
                grid-template-columns: 1fr;
                gap: 12px;
            }
            
            .stat-card {
                padding: 16px 12px;
            }
            
            .buy-section {
                padding: 20px 16px;
            }
            
            .input-group {
                gap: 12px;
            }
            
            .buy-input {
                padding: 12px 14px;
                font-size: 15px;
            }
            
            .buy-btn {
                padding: 12px 24px;
                font-size: 15px;
            }
            
            .modal-content {
                padding: 25px 20px;
                margin: 0 10px;
            }
            
            .wallet-option {
                padding: 15px 12px;
            }
            
            .wallet-icon {
                width: 36px;
                height: 36px;
                font-size: 14px;
            }
        }
        
        @media (max-width: 480px) {
            .input-group {
                flex-direction: column;
                align-items: stretch;
            }
            
            .buy-input {
                max-width: none;
            }
            
            .conversion-arrow {
                transform: rotate(90deg);
            }
        }
        
        /* Loading States */
        .loading {
            position: relative;
            overflow: hidden;
        }
        
        .loading::after {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(45, 212, 191, 0.3), transparent);
            animation: loading 1.5s infinite;
        }
        
        @keyframes loading {
            0% { left: -100%; }
            100% { left: 100%; }
        }
    </style>
</head>
<body>
    <!-- Wallet Connection Modal -->
    <div id="walletModal" class="wallet-modal">
        <div class="modal-content">
            <button class="close-modal" onclick="closeWalletModal()">&times;</button>
            <h2 class="modal-title">Connect Wallet</h2>
            
            <div class="wallet-option" onclick="connectMetaMask()">
                <div class="wallet-icon">M</div>
                <div class="wallet-info">
                    <h3>MetaMask</h3>
                    <p>Connect with MetaMask wallet</p>
                </div>
            </div>
            
            <div class="wallet-option" onclick="connectWalletConnect()">
                <div class="wallet-icon">W</div>
                <div class="wallet-info">
                    <h3>WalletConnect</h3>
                    <p>Connect with mobile wallets</p>
                </div>
            </div>
            
            <div class="wallet-option" onclick="connectCoinbase()">
                <div class="wallet-icon">C</div>
                <div class="wallet-info">
                    <h3>Coinbase Wallet</h3>
                    <p>Connect with Coinbase</p>
                </div>
            </div>
            
            <div class="wallet-option" onclick="connectRainbow()">
                <div class="wallet-icon">R</div>
                <div class="wallet-info">
                    <h3>Rainbow</h3>
                    <p>Connect with Rainbow wallet</p>
                </div>
            </div>
        </div>
    </div>

    <div class="header">
        <div class="logo">
            <svg width="40" height="40" viewBox="0 0 100 100">
                <defs>
                    <linearGradient id="logoGrad" x1="0%" y1="0%" x2="100%" y2="100%">
                        <stop offset="0%" style="stop-color:#2dd4bf"/>
                        <stop offset="100%" style="stop-color:#14b8a6"/>
                    </linearGradient>
                </defs>
                <circle cx="50" cy="50" r="45" fill="url(#logoGrad)"/>
                <text x="50" y="58" text-anchor="middle" fill="white" font-family="Inter" font-weight="700" font-size="32">HF</text>
            </svg>
            <div>
                <h1>HyperFlow</h1>
                <p>DeFi Protocol</p>
            </div>
        </div>
        
        <button id="connectBtn" class="connect-btn" onclick="openWalletModal()">
            Connect Wallet
        </button>
    </div>

    <div class="main-content">
        <h1 class="title">HyperFlow Protocol</h1>
        <h2 class="subtitle">Advanced DeFi Infrastructure</h2>
        <p class="description">
            Secure presale for FLOW tokens on HyperEVM with enhanced mobile wallet connectivity
        </p>
        
        <div id="walletStatus" class="wallet-status">
            <div class="status-text">Wallet Connected</div>
            <div id="walletAddress" class="wallet-address"></div>
        </div>
        
        <div class="presale-section">
            <h3 class="presale-title">FLOW Token Presale</h3>
            
            <div class="presale-stats">
                <div class="stat-card">
                    <div class="stat-label">Total Supply</div>
                    <div class="stat-value">1B FLOW</div>
                </div>
                <div class="stat-card">
                    <div class="stat-label">Presale Allocation</div>
                    <div class="stat-value">50M FLOW (5%)</div>
                </div>
                <div class="stat-card">
                    <div class="stat-label">Exchange Rate</div>
                    <div class="stat-value">25,000 FLOW per HYPE</div>
                </div>
                <div class="stat-card">
                    <div class="stat-label">Hard Cap</div>
                    <div class="stat-value">2,000 HYPE</div>
                </div>
            </div>
            
            <div class="buy-section">
                <p style="margin-bottom: 20px; color: #e2e8f0;">Enter HYPE amount to purchase FLOW tokens:</p>
                <div class="input-group">
                    <input type="number" id="hyeInput" class="buy-input" placeholder="0.0" step="0.001" min="0.001" max="2000">
                    <div class="conversion-arrow">â†“</div>
                    <input type="text" id="flowOutput" class="buy-input" placeholder="0 FLOW" readonly>
                </div>
                <button id="buyBtn" class="buy-btn" disabled onclick="buyTokens()">Buy FLOW</button>
            </div>
        </div>
    </div>

    <script>
        // Global variables
        const connectBtn = document.getElementById('connectBtn');
        const walletStatus = document.getElementById('walletStatus');
        const walletAddress = document.getElementById('walletAddress');
        const hyeInput = document.getElementById('hyeInput');
        const flowOutput = document.getElementById('flowOutput');
        const buyBtn = document.getElementById('buyBtn');
        const walletModal = document.getElementById('walletModal');
        
        let isConnected = false;
        let userAddress = '';
        let currentProvider = null;
        
        // Mobile detection
        const isMobile = /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent);
        const isIOS = /iPad|iPhone|iPod/.test(navigator.userAgent);
        const isAndroid = /Android/.test(navigator.userAgent);
        
        // App bundle identifiers
        const APP_CONFIG = {
            ios: {
                bundleIdentifier: "com.hyperflow.app"
            },
            android: {
                package: "com.hyperflow.app"
            }
        };
        
        // Calculate FLOW tokens
        hyeInput.addEventListener('input', function() {
            const hyeAmount = parseFloat(this.value) || 0;
            const flowAmount = hyeAmount * 25000; // 25,000 FLOW per HYPE
            flowOutput.value = flowAmount.toLocaleString() + ' FLOW';
            buyBtn.disabled = !isConnected || hyeAmount <= 0;
        });
        
        // Modal functions
        function openWalletModal() {
            if (isConnected) {
                disconnectWallet();
            } else {
                walletModal.style.display = 'flex';
                document.body.style.overflow = 'hidden'; // Prevent scroll on mobile
            }
        }
        
        function closeWalletModal() {
            walletModal.style.display = 'none';
            document.body.style.overflow = ''; // Restore scroll
        }
        
        // Enhanced mobile deep linking
        function createMobileDeepLink(walletType, uri) {
            const encodedUri = encodeURIComponent(uri);
            
            switch (walletType.toLowerCase()) {
                case 'metamask':
                    return isMobile ? `metamask://wc?uri=${encodedUri}` : uri;
                case 'rainbow':
                    return isMobile ? `rainbow://wc?uri=${encodedUri}` : uri;
                case 'coinbase':
                    return isMobile ? `coinbase://wc?uri=${encodedUri}` : uri;
                case 'trust':
                    return isMobile ? `trust://wc?uri=${encodedUri}` : uri;
                default:
                    return uri;
            }
        }
        
        // Wallet connection functions
        async function connectMetaMask() {
            try {
                closeWalletModal();
                setLoadingState(connectBtn, 'Connecting...');
                
                if (typeof window.ethereum !== 'undefined') {
                    const accounts = await window.ethereum.request({
                        method: 'eth_requestAccounts'
                    });
                    
                    if (accounts.length > 0) {
                        currentProvider = window.ethereum;
                        await switchToHyperEVM();
                        await handleWalletConnection(accounts[0], 'MetaMask');
                    }
                } else if (isMobile) {
                    // Redirect to MetaMask mobile app
                    window.open('https://metamask.app.link/dapp/' + window.location.host, '_blank');
                    handleConnectionError('Please install MetaMask mobile app');
                } else {
                    window.open('https://metamask.io/download/', '_blank');
                    handleConnectionError('Please install MetaMask extension');
                }
                
            } catch (error) {
                console.error('MetaMask connection failed:', error);
                handleConnectionError('MetaMask connection failed');
            }
        }
        
        async function connectWalletConnect() {
            try {
                closeWalletModal();
                setLoadingState(connectBtn, 'Connecting...');
                
                // Enhanced WalletConnect configuration for mobile
                const { EthereumProvider } = await import('https://unpkg.com/@walletconnect/ethereum-provider@2.11.0/dist/index.es.js');
                
                const provider = await EthereumProvider.init({
                    projectId: 'ca21cf0275758f8258a17ae99f6148d4',
                    chains: [999],
                    showQrModal: true,
                    qrModalOptions: {
                        mobileWallets: [
                            {
                                id: 'rainbow',
                                name: 'Rainbow',
                                links: {
                                    native: 'rainbow://',
                                    universal: 'https://rainbow.me'
                                }
                            },
                            {
                                id: 'metamask',
                                name: 'MetaMask',
                                links: {
                                    native: 'metamask://',
                                    universal: 'https://metamask.app.link'
                                }
                            },
                            {
                                id: 'trust',
                                name: 'Trust Wallet',
                                links: {
                                    native: 'trust://',
                                    universal: 'https://link.trustwallet.com'
                                }
                            }
                        ],
                        desktopWallets: [
                            {
                                id: 'metamask',
                                name: 'MetaMask',
                                links: {
                                    native: '',
                                    universal: 'https://metamask.io'
                                }
                            }
                        ]
                    },
                    rpcMap: {
                        999: 'https://rpc.hyperliquid.xyz/evm'
                    },
                    metadata: {
                        name: 'HyperFlow Protocol',
                        description: 'Advanced DeFi Infrastructure for HyperEVM',
                        url: window.location.origin,
                        icons: [window.location.origin + '/hyperflow_logo.svg'],
                        redirect: {
                            native: APP_CONFIG.ios.bundleIdentifier,
                            universal: window.location.origin
                        }
                    }
                });
                
                await provider.connect();
                const accounts = await provider.request({ method: 'eth_accounts' });
                
                if (accounts.length > 0) {
                    currentProvider = provider;
                    await handleWalletConnection(accounts[0], 'WalletConnect');
                }
                
            } catch (error) {
                console.error('WalletConnect connection failed:', error);
                handleConnectionError('WalletConnect connection failed');
            }
        }
        
        async function connectCoinbase() {
            try {
                closeWalletModal();
                setLoadingState(connectBtn, 'Connecting...');
                
                if (typeof window.ethereum !== 'undefined' && window.ethereum.isCoinbaseWallet) {
                    const accounts = await window.ethereum.request({
                        method: 'eth_requestAccounts'
                    });
                    
                    if (accounts.length > 0) {
                        currentProvider = window.ethereum;
                        await switchToHyperEVM();
                        await handleWalletConnection(accounts[0], 'Coinbase');
                    }
                } else if (isMobile) {
                    // Enhanced mobile deep linking for Coinbase
                    const deepLink = `coinbase://dapp?url=${encodeURIComponent(window.location.href)}`;
                    window.open(deepLink, '_blank');
                    
                    // Fallback to app store
                    setTimeout(() => {
                        if (isIOS) {
                            window.open('https://apps.apple.com/app/coinbase-wallet/id1278383455', '_blank');
                        } else if (isAndroid) {
                            window.open('https://play.google.com/store/apps/details?id=org.toshi', '_blank');
                        }
                    }, 2000);
                    
                    handleConnectionError('Please install Coinbase Wallet');
                } else {
                    window.open('https://wallet.coinbase.com/', '_blank');
                    handleConnectionError('Please install Coinbase Wallet extension');
                }
                
            } catch (error) {
                console.error('Coinbase connection failed:', error);
                handleConnectionError('Coinbase connection failed');
            }
        }
        
        async function connectRainbow() {
            try {
                closeWalletModal();
                setLoadingState(connectBtn, 'Connecting...');
                
                if (isMobile) {
                    // Enhanced Rainbow mobile deep linking
                    const deepLink = `rainbow://dapp?url=${encodeURIComponent(window.location.href)}`;
                    window.open(deepLink, '_blank');
                    
                    // Fallback to app store
                    setTimeout(() => {
                        if (isIOS) {
                            window.open('https://apps.apple.com/app/rainbow-ethereum-wallet/id1457119021', '_blank');
                        } else if (isAndroid) {
                            window.open('https://play.google.com/store/apps/details?id=me.rainbow', '_blank');
                        }
                    }, 2000);
                    
                    handleConnectionError('Please install Rainbow Wallet');
                } else {
                    // Try WalletConnect for desktop Rainbow
                    await connectWalletConnect();
                }
                
            } catch (error) {
                console.error('Rainbow connection failed:', error);
                handleConnectionError('Rainbow connection failed');
            }
        }
        
        async function switchToHyperEVM() {
            if (!currentProvider) return;
            
            try {
                await currentProvider.request({
                    method: 'wallet_switchEthereumChain',
                    params: [{ chainId: '0x3e7' }], // 999 in hex
                });
            } catch (switchError) {
                if (switchError.code === 4902) {
                    await currentProvider.request({
                        method: 'wallet_addEthereumChain',
                        params: [{
                            chainId: '0x3e7',
                            chainName: 'HyperEVM',
                            nativeCurrency: {
                                name: 'HYPE',
                                symbol: 'HYPE',
                                decimals: 18
                            },
                            rpcUrls: ['https://rpc.hyperliquid.xyz/evm'],
                            blockExplorerUrls: ['https://explorer.hyperliquid.xyz']
                        }]
                    });
                }
            }
        }
        
        function setLoadingState(button, text) {
            button.textContent = text;
            button.disabled = true;
            button.classList.add('loading');
        }
        
        function clearLoadingState(button, text) {
            button.textContent = text;
            button.disabled = false;
            button.classList.remove('loading');
        }
        
        async function handleWalletConnection(address, walletType) {
            userAddress = address;
            isConnected = true;
            
            clearLoadingState(connectBtn, `Disconnect (${walletType})`);
            walletStatus.style.display = 'block';
            walletAddress.textContent = userAddress;
            
            // Update buy button state
            const hyeAmount = parseFloat(hyeInput.value) || 0;
            buyBtn.disabled = hyeAmount <= 0;
            
            console.log(`${walletType} connected:`, userAddress);
            
            // Haptic feedback on mobile
            if (isMobile && 'vibrate' in navigator) {
                navigator.vibrate(100);
            }
        }
        
        function handleConnectionError(message) {
            clearLoadingState(connectBtn, 'Connection Failed');
            
            setTimeout(() => {
                clearLoadingState(connectBtn, 'Connect Wallet');
            }, 3000);
            
            // Enhanced error handling for mobile
            if (isMobile) {
                // Show native alert on mobile for better UX
                alert(message + '. Please try again.');
            } else {
                console.error(message);
            }
        }
        
        function disconnectWallet() {
            isConnected = false;
            userAddress = '';
            currentProvider = null;
            
            clearLoadingState(connectBtn, 'Connect Wallet');
            walletStatus.style.display = 'none';
            buyBtn.disabled = true;
            
            console.log('Wallet disconnected');
        }
        
        async function buyTokens() {
            if (!isConnected) {
                openWalletModal();
                return;
            }
            
            const hyeAmount = parseFloat(hyeInput.value);
            if (hyeAmount <= 0) {
                alert('Please enter a valid HYPE amount');
                return;
            }
            
            try {
                setLoadingState(buyBtn, 'Processing...');
                
                console.log(`Processing purchase of ${hyeAmount} HYPE worth of FLOW tokens...`);
                
                // Simulate transaction processing with enhanced mobile feedback
                await new Promise(resolve => setTimeout(resolve, 2000));
                
                const flowAmount = (hyeAmount * 25000).toLocaleString();
                alert(`Successfully purchased ${flowAmount} FLOW tokens!`);
                
                // Haptic feedback on successful purchase
                if (isMobile && 'vibrate' in navigator) {
                    navigator.vibrate([100, 50, 100]);
                }
                
                clearLoadingState(buyBtn, 'Buy FLOW');
                
            } catch (error) {
                console.error('Purchase failed:', error);
                alert('Transaction failed. Please try again.');
                clearLoadingState(buyBtn, 'Buy FLOW');
            }
        }
        
        // Enhanced mobile event handling
        walletModal.addEventListener('click', function(e) {
            if (e.target === walletModal) {
                closeWalletModal();
            }
        });
        
        // Prevent iOS bounce scroll
        document.addEventListener('touchmove', function(e) {
            if (walletModal.style.display === 'flex') {
                e.preventDefault();
            }
        }, { passive: false });
        
        // Enhanced keyboard handling for mobile
        document.addEventListener('keydown', function(e) {
            if (e.key === 'Escape' && walletModal.style.display === 'flex') {
                closeWalletModal();
            }
        });
        
        // App visibility handling for mobile deep links
        document.addEventListener('visibilitychange', function() {
            if (document.visibilityState === 'visible' && connectBtn.textContent === 'Connecting...') {
                // User returned to the app, check connection status
                setTimeout(() => {
                    if (!isConnected) {
                        clearLoadingState(connectBtn, 'Connect Wallet');
                    }
                }, 1000);
            }
        });
        
        // Initialize
        console.log('HyperFlow Presale initialized with mobile enhancements');
        console.log('Platform:', isMobile ? 'Mobile' : 'Desktop');
        console.log('iOS:', isIOS);
        console.log('Android:', isAndroid);
        console.log('WalletConnect Project ID: ca21cf0275758f8258a17ae99f6148d4');
        console.log('Chain: HyperEVM (999)');
        console.log('App Config:', APP_CONFIG);
    </script>
</body>
</html>